
<!-- 用户详情页面 -->
<view class="page-container">
  <!-- 顶部导航栏 -->
  <view class="nav-bar">
    <view class="nav-content">
      <button class="back-btn" bindtap="handleBack">
        <image src="/images/arrow-left.png" class="back-icon" />
      </button>
      <text class="nav-title">用户详情</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-container">
    <image src="/images/loading.gif" class="loading-icon" />
    <text class="loading-text">加载中...</text>
  </view>

  <!-- 用户不存在状态 -->
  <view wx:if="{{!loading && !userData}}" class="empty-container">
    <image src="/images/user-empty.png" class="empty-icon" />
    <text class="empty-text">用户不存在</text>
    <button class="back-button" bindtap="handleBack">返回</button>
  </view>

  <!-- 用户详情内容 -->
  <scroll-view wx:if="{{!loading && userData}}" class="content-container" scroll-y="true">
    <!-- 用户基本信息卡片 -->
    <view class="card">
      <view class="card-header">
        <view class="card-title">
          <image src="/images/user-icon.png" class="card-icon" />
          <text>基本信息</text>
        </view>
        <button class="edit-btn" bindtap="handleOpenBasicEdit">
          <image src="/images/edit.png" class="edit-icon" />
        </button>
      </view>
      <view class="card-content">
        <!-- 用户头像和姓名 -->
        <view class="user-avatar-section">
          <view class="avatar">
            <text class="avatar-text">{{userInitial}}</text>
          </view>
          <view class="user-info">
            <text class="user-name">{{userData && userData.name ? userData.name : '未命名用户'}}</text>
            <text class="user-id">用户ID: {{userId}}</text>
          </view>
        </view>

        <!-- 手机号 -->
        <view class="info-item">
          <image src="/images/phone.png" class="info-icon" />
          <text class="info-text">{{userData && userData.phone ? userData.phone : '未设置手机号'}}</text>
        </view>

        <!-- 地址 -->
        <view class="info-item">
          <image src="/images/map-pin.png" class="info-icon" />
          <text class="info-text">{{userData && userData.address ? userData.address : '未设置地址'}}</text>
        </view>
      </view>
    </view>

    <!-- 健康档案卡片 -->
    <view class="card">
      <view class="card-header">
        <view class="card-title">
          <image src="/images/pill.png" class="card-icon" />
          <text>健康档案</text>
        </view>
        <button class="edit-btn" bindtap="handleOpenHealthEdit">
          <image src="/images/edit.png" class="edit-icon" />
        </button>
      </view>
      <view class="card-content">
        <!-- 基础疾病 -->
        <view class="health-section">
          <text class="section-label">基础疾病</text>
          <view class="diseases-container">
            <block wx:if="{{userData && userData.diseases && userData.diseases.length > 0}}">
              <view wx:for="{{userData.diseases}}" wx:key="index" class="disease-tag">
                <text>{{item}}</text>
              </view>
            </block>
            <text wx:else class="empty-tag">暂无基础疾病</text>
          </view>
        </view>

        <!-- 用药情况 -->
        <view class="health-section">
          <text class="section-label">用药情况</text>
          <view class="medications-container">
            <block wx:if="{{userData && userData.medications && userData.medications.length > 0}}">
              <view wx:for="{{userData.medications}}" wx:key="index" class="medication-item">
                <view class="medication-dot"></view>
                <text>{{item}}</text>
              </view>
            </block>
            <text wx:else class="empty-text">暂无用药记录</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 随访记录卡片 -->
    <view class="card">
      <view class="card-header">
        <view class="card-title">
          <image src="/images/calendar.png" class="card-icon" />
          <text>随访记录</text>
        </view>
      </view>
      <view class="card-content">
        <block wx:if="{{userData && userData.followups && userData.followups.length > 0}}">
          <view wx:for="{{userData.followups}}" wx:key="index" class="followup-item">
            <view class="followup-header">
              <text class="followup-date">{{item.formattedFollowupDate || item.followupDate || '未设置日期'}}</text>
              <view class="followup-actions">
                <!-- 只显示最近一条记录的修改按钮 -->
                <button 
                  wx:if="{{index === userData.followups.length - 1}}" 
                  class="edit-followup-btn" 
                  bindtap="handleEditFollowup" 
                  data-index="{{index}}"
                >
                  <image src="/images/edit.png" class="edit-icon-small" />
                </button>
                <view wx:if="{{item.nextFollowupDate}}" class="next-followup-badge {{item.nextFollowupStatus}}">
                  <text>下次: {{item.formattedNextFollowupDate || item.nextFollowupDate}}</text>
                </view>
              </view>
            </view>
            <text class="followup-content">{{item.content || '无随访内容'}}</text>
          </view>
        </block>
        <view wx:else class="empty-followup">
          <text>暂无随访记录</text>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 底部新增随访按钮 -->
  <view wx:if="{{!loading && userData}}" class="bottom-action-bar">
    <button class="add-followup-btn" bindtap="handleAddFollowup" disabled="{{saving}}">
      <image wx:if="{{saving}}" src="/images/loading.gif" class="btn-loading" />
      <text>{{saving ? '保存中...' : '新增随访记录'}}</text>
    </button>
  </view>

  <!-- 基本信息编辑弹窗 -->
  <view wx:if="{{showBasicEditDialog}}" class="modal">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">修改基本信息</text>
        <text class="modal-subtitle">修改用户的电话和地址信息</text>
        <button class="close-btn" bindtap="hideModal">
          <image src="/images/close.png" class="close-icon" />
        </button>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <label class="form-label">手机号</label>
          <input 
            type="text" 
            value="{{editForm.phone}}" 
            placeholder="请输入手机号" 
            disabled="{{saving}}"
            bindinput="onEditFormInput"
            data-field="phone"
            class="form-input"
          />
        </view>

        <view class="form-group">
          <label class="form-label">地址</label>
          <input 
            type="text" 
            value="{{editForm.address}}" 
            placeholder="请输入详细地址" 
            disabled="{{saving}}"
            bindinput="onEditFormInput"
            data-field="address"
            class="form-input"
          />
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideModal" disabled="{{saving}}">取消</button>
        <button class="btn-confirm" bindtap="handleSaveBasicEdit" disabled="{{saving}}">
          <image wx:if="{{saving}}" src="/images/loading.gif" class="btn-loading" />
          <text>保存</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 健康档案编辑弹窗 -->
  <view wx:if="{{showHealthEditDialog}}" class="modal">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">修改健康档案</text>
        <text class="modal-subtitle">修改基础疾病和用药情况</text>
        <button class="close-btn" bindtap="hideModal">
          <image src="/images/close.png" class="close-icon" />
        </button>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <label class="form-label">基础疾病</label>
          <input 
            type="text" 
            value="{{editForm.diseases}}" 
            placeholder="多个疾病用、分隔，单条疾病直接填写" 
            disabled="{{saving}}"
            bindinput="onEditFormInput"
            data-field="diseases"
            class="form-input"
          />
        </view>

        <view class="form-group">
          <label class="form-label">用药情况</label>
          <textarea 
            value="{{editForm.medications}}" 
            placeholder="每行一种用药，格式：药名-用法，单条用药直接填写" 
            disabled="{{saving}}"
            bindinput="onEditFormInput"
            data-field="medications"
            class="form-textarea"
            rows="3"
          />
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideModal" disabled="{{saving}}">取消</button>
        <button class="btn-confirm" bindtap="handleSaveHealthEdit" disabled="{{saving}}">
          <image wx:if="{{saving}}" src="/images/loading.gif" class="btn-loading" />
          <text>保存</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 新增随访弹窗 -->
  <view wx:if="{{showFollowupDialog}}" class="modal">
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title-with-icon">
          <image src="/images/calendar.png" class="modal-title-icon" />
          <text>新增随访记录</text>
        </view>
        <text class="modal-subtitle">填写本次随访内容和下次随访时间</text>
        <button class="close-btn" bindtap="hideModal">
          <image src="/images/close.png" class="close-icon" />
        </button>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <label class="form-label">本次随访日期</label>
          <input 
            type="date" 
            value="{{newFollowup.followupDate}}" 
            disabled="{{saving}}"
            bindinput="onNewFollowupInput"
            data-field="followupDate"
            class="form-input"
          />
        </view>

        <view class="form-group">
          <label class="form-label">下次随访日期</label>
          <input 
            type="date" 
            value="{{newFollowup.nextFollowupDate}}" 
            disabled="{{saving}}"
            bindinput="onNewFollowupInput"
            data-field="nextFollowupDate"
            class="form-input"
          />
        </view>

        <view class="form-group">
          <label class="form-label">随访内容</label>
          <textarea 
            value="{{newFollowup.content}}" 
            placeholder="请输入本次随访的具体内容和建议..." 
            disabled="{{saving}}"
            bindinput="onNewFollowupInput"
            data-field="content"
            class="form-textarea"
            rows="3"
          />
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideModal" disabled="{{saving}}">取消</button>
        <button class="btn-confirm" bindtap="handleSaveFollowup" disabled="{{saving}}">
          <image wx:if="{{saving}}" src="/images/loading.gif" class="btn-loading" />
          <text>保存</text>
        </button>
      </view>
    </view>
  </view>

  <!-- 编辑随访弹窗 -->
  <view wx:if="{{showEditFollowupDialog}}" class="modal">
    <view class="modal-content">
      <view class="modal-header">
        <view class="modal-title-with-icon">
          <image src="/images/calendar.png" class="modal-title-icon" />
          <text>编辑随访记录</text>
        </view>
        <text class="modal-subtitle">修改本次随访内容和下次随访时间</text>
        <button class="close-btn" bindtap="hideModal">
          <image src="/images/close.png" class="close-icon" />
        </button>
      </view>

      <view class="modal-body">
        <view class="form-group">
          <label class="form-label">本次随访日期</label>
          <input 
            type="date" 
            value="{{editFollowupForm.followupDate}}" 
            disabled="{{saving}}"
            bindinput="onEditFollowupInput"
            data-field="followupDate"
            class="form-input"
          />
        </view>

        <view class="form-group">
          <label class="form-label">下次随访日期</label>
          <input 
            type="date" 
            value="{{editFollowupForm.nextFollowupDate}}" 
            disabled="{{saving}}"
            bindinput="onEditFollowupInput"
            data-field="nextFollowupDate"
            class="form-input"
          />
        </view>

        <view class="form-group">
          <label class="form-label">随访内容</label>
          <textarea 
            value="{{editFollowupForm.content}}" 
            placeholder="请输入本次随访的具体内容和建议..." 
            disabled="{{saving}}"
            bindinput="onEditFollowupInput"
            data-field="content"
            class="form-textarea"
            rows="3"
          />
        </view>
      </view>

      <view class="modal-footer">
        <button class="btn-cancel" bindtap="hideModal" disabled="{{saving}}">取消</button>
        <button class="btn-confirm" bindtap="handleSaveEditFollowup" disabled="{{saving}}">
          <image wx:if="{{saving}}" src="/images/loading.gif" class="btn-loading" />
          <text>保存</text>
        </button>
      </view>
    </view>
  </view>
</view>
