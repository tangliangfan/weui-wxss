
<!-- 用户详情页面 -->
<view class="page-container">
  <!-- 顶部导航栏 -->
  <view class="weui-navbar">
    <view class="weui-navbar__inner">
      <button class="weui-btn weui-btn_default weui-btn_icon" bindtap="handleBack">
        <i class="weui-icon-back"></i>
      </button>
      <text class="weui-navbar__title">用户详情</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="weui-loadmore">
    <i class="weui-loading"></i>
    <text class="weui-loadmore__tips">加载中...</text>
  </view>

  <!-- 用户不存在状态 -->
  <view wx:if="{{!loading && !userData}}" class="weui-empty">
    <i class="weui-icon-info-circle weui-icon_gray"></i>
    <text class="weui-empty__description">用户不存在</text>
    <button class="weui-btn weui-btn_primary" bindtap="handleBack">返回</button>
  </view>

  <!-- 用户详情内容 -->
  <scroll-view wx:if="{{!loading && userData}}" class="content-container" scroll-y="true">
    <!-- 用户基本信息卡片 -->
    <view class="weui-panel">
      <view class="weui-panel__hd">
        <view class="weui-panel__hd__inner">
          <i class="weui-icon-user weui-icon_gray"></i>
          <text>基本信息</text>
        </view>
        <button class="weui-btn weui-btn_default weui-btn_icon" bindtap="handleOpenBasicEdit">
          <i class="weui-icon-edit"></i>
        </button>
      </view>
      <view class="weui-panel__bd">
        <!-- 用户头像和姓名 -->
        <view class="weui-cell">
          <view class="weui-cell__hd">
            <view class="weui-avatar weui-avatar_large">
              <text class="weui-avatar__text">{{userInitial}}</text>
            </view>
          </view>
          <view class="weui-cell__bd">
            <text class="weui-cell__title">{{userData && userData.name ? userData.name : '未命名用户'}}</text>
            <text class="weui-cell__desc">用户ID: {{userId}}</text>
          </view>
        </view>

        <!-- 手机号 -->
        <view class="weui-cell">
          <view class="weui-cell__hd">
            <i class="weui-icon-phone weui-icon_gray"></i>
          </view>
          <view class="weui-cell__bd">
            <text class="weui-cell__title">{{userData && userData.phone ? userData.phone : '未设置手机号'}}</text>
          </view>
        </view>

        <!-- 地址 -->
        <view class="weui-cell">
          <view class="weui-cell__hd">
            <i class="weui-icon-location weui-icon_gray"></i>
          </view>
          <view class="weui-cell__bd">
            <text class="weui-cell__title">{{userData && userData.address ? userData.address : '未设置地址'}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- 健康档案卡片 -->
    <view class="weui-panel">
      <view class="weui-panel__hd">
        <view class="weui-panel__hd__inner">
          <i class="weui-icon-pill weui-icon_gray"></i>
          <text>健康档案</text>
        </view>
        <button class="weui-btn weui-btn_default weui-btn_icon" bindtap="handleOpenHealthEdit">
          <i class="weui-icon-edit"></i>
        </button>
      </view>
      <view class="weui-panel__bd">
        <!-- 基础疾病 -->
        <view class="weui-cell">
          <view class="weui-cell__hd">
            <i class="weui-icon-medical weui-icon_gray"></i>
          </view>
          <view class="weui-cell__bd">
            <text class="weui-cell__title">基础疾病</text>
            <view class="weui-cell__desc">
              <block wx:if="{{userData && userData.diseases && userData.diseases.length > 0}}">
                <view wx:for="{{userData.diseases}}" wx:key="index" class="weui-tag">
                  <text>{{item}}</text>
                </view>
              </block>
              <text wx:else class="weui-cell__desc">暂无基础疾病</text>
            </view>
          </view>
        </view>

        <!-- 用药情况 -->
        <view class="weui-cell">
          <view class="weui-cell__hd">
            <i class="weui-icon-medicine weui-icon_gray"></i>
          </view>
          <view class="weui-cell__bd">
            <text class="weui-cell__title">用药情况</text>
            <view class="weui-cell__desc">
              <block wx:if="{{userData && userData.medications && userData.medications.length > 0}}">
                <view wx:for="{{userData.medications}}" wx:key="index" class="weui-cell__desc-item">
                  <i class="weui-icon-dot"></i>
                  <text>{{item}}</text>
                </view>
              </block>
              <text wx:else class="weui-cell__desc">暂无用药记录</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 随访记录卡片 -->
    <view class="weui-panel">
      <view class="weui-panel__hd">
        <view class="weui-panel__hd__inner">
          <i class="weui-icon-time weui-icon_gray"></i>
          <text>随访记录</text>
        </view>
      </view>
      <view class="weui-panel__bd">
        <block wx:if="{{userData && userData.followups && userData.followups.length > 0}}">
          <view wx:for="{{userData.followups}}" wx:key="index" class="weui-cell weui-cell_access">
            <view class="weui-cell__hd">
              <i class="weui-icon-calendar weui-icon_gray"></i>
            </view>
            <view class="weui-cell__bd">
              <text class="weui-cell__title">{{item.formattedFollowupDate || item.followupDate || '未设置日期'}}</text>
              <text class="weui-cell__desc">{{item.content || '无随访内容'}}</text>
              <view wx:if="{{item.nextFollowupDate}}" class="weui-badge weui-badge_success">
                <text>下次: {{item.formattedNextFollowupDate || item.nextFollowupDate}}</text>
              </view>
            </view>
          </view>
        </block>
        <view wx:else class="weui-empty weui-empty_small">
          <i class="weui-icon-time weui-icon_gray"></i>
          <text class="weui-empty__description">暂无随访记录</text>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 底部新增随访按钮 -->
  <view wx:if="{{!loading && userData}}" class="weui-actionsheet">
    <button class="weui-btn weui-btn_primary" bindtap="handleAddFollowup" disabled="{{saving}}">
      <i class="weui-icon-add weui-icon_in-btn"></i>
      <text>{{saving ? '保存中...' : '新增随访记录'}}</text>
    </button>
  </view>

  <!-- 基本信息编辑弹窗 -->
  <view wx:if="{{showBasicEditDialog}}" class="weui-dialog">
    <view class="weui-dialog__hd">
      <text class="weui-dialog__title">修改基本信息</text>
      <text class="weui-dialog__subtitle">修改用户的电话和地址信息</text>
      <button class="weui-btn weui-btn_default weui-btn_mini" bindtap="hideModal">
        <i class="weui-icon-close"></i>
      </button>
    </view>

    <view class="weui-dialog__bd">
      <view class="weui-cells weui-cells_form">
        <view class="weui-cell">
          <view class="weui-cell__hd">
            <label class="weui-label">手机号</label>
          </view>
          <view class="weui-cell__bd">
            <input 
              type="text" 
              value="{{editForm.phone}}" 
              placeholder="请输入手机号" 
              disabled="{{saving}}"
              bindinput="onEditFormInput"
              data-field="phone"
              class="weui-input"
            />
          </view>
        </view>

        <view class="weui-cell">
          <view class="weui-cell__hd">
            <label class="weui-label">地址</label>
          </view>
          <view class="weui-cell__bd">
            <input 
              type="text" 
              value="{{editForm.address}}" 
              placeholder="请输入详细地址" 
              disabled="{{saving}}"
              bindinput="onEditFormInput"
              data-field="address"
              class="weui-input"
            />
          </view>
        </view>
      </view>
    </view>

    <view class="weui-dialog__ft">
      <button class="weui-btn weui-btn_default" bindtap="hideModal" disabled="{{saving}}">取消</button>
      <button class="weui-btn weui-btn_primary" bindtap="handleSaveBasicEdit" disabled="{{saving}}">
        <i wx:if="{{saving}}" class="weui-loading weui-icon_in-btn"></i>
        <text>保存</text>
      </button>
    </view>
  </view>

  <!-- 健康档案编辑弹窗 -->
  <view wx:if="{{showHealthEditDialog}}" class="weui-dialog">
    <view class="weui-dialog__hd">
      <text class="weui-dialog__title">修改健康档案</text>
      <text class="weui-dialog__subtitle">修改基础疾病和用药情况</text>
      <button class="weui-btn weui-btn_default weui-btn_mini" bindtap="hideModal">
        <i class="weui-icon-close"></i>
      </button>
    </view>

    <view class="weui-dialog__bd">
      <view class="weui-cells weui-cells_form">
        <view class="weui-cell">
          <view class="weui-cell__hd">
            <label class="weui-label">基础疾病</label>
          </view>
          <view class="weui-cell__bd">
            <input 
              type="text" 
              value="{{editForm.diseases}}" 
              placeholder="多个疾病用、分隔，单条疾病直接填写" 
              disabled="{{saving}}"
              bindinput="onEditFormInput"
              data-field="diseases"
              class="weui-input"
            />
          </view>
        </view>

        <view class="weui-cell">
          <view class="weui-cell__hd">
            <label class="weui-label">用药情况</label>
          </view>
          <view class="weui-cell__bd">
            <textarea 
              value="{{editForm.medications}}" 
              placeholder="每行一种用药，格式：药名-用法，单条用药直接填写" 
              disabled="{{saving}}"
              bindinput="onEditFormInput"
              data-field="medications"
              class="weui-textarea"
              rows="3"
            />
          </view>
        </view>
      </view>
    </view>

    <view class="weui-dialog__ft">
      <button class="weui-btn weui-btn_default" bindtap="hideModal" disabled="{{saving}}">取消</button>
      <button class="weui-btn weui-btn_primary" bindtap="handleSaveHealthEdit" disabled="{{saving}}">
        <i wx:if="{{saving}}" class="weui-loading weui-icon_in-btn"></i>
        <text>保存</text>
      </button>
    </view>
  </view>

  <!-- 新增随访弹窗 -->
  <view wx:if="{{showFollowupDialog}}" class="weui-dialog">
    <view class="weui-dialog__hd">
      <view class="weui-dialog__title-with-icon">
        <i class="weui-icon-calendar"></i>
        <text>新增随访记录</text>
      </view>
      <text class="weui-dialog__subtitle">填写本次随访内容和下次随访时间</text>
      <button class="weui-btn weui-btn_default weui-btn_mini" bindtap="hideModal">
        <i class="weui-icon-close"></i>
      </button>
    </view>

    <view class="weui-dialog__bd">
      <view class="weui-cells weui-cells_form">
        <view class="weui-cell">
          <view class="weui-cell__hd">
            <label class="weui-label">本次随访日期</label>
          </view>
          <view class="weui-cell__bd">
            <input 
              type="date" 
              value="{{newFollowup.followupDate}}" 
              disabled="{{saving}}"
              bindinput="onNewFollowupInput"
              data-field="followupDate"
              class="weui-input"
            />
          </view>
        </view>

        <view class="weui-cell">
          <view class="weui-cell__hd">
            <label class="weui-label">下次随访日期</label>
          </view>
          <view class="weui-cell__bd">
            <input 
              type="date" 
              value="{{newFollowup.nextFollowupDate}}" 
              disabled="{{saving}}"
              bindinput="onNewFollowupInput"
              data-field="nextFollowupDate"
              class="weui-input"
            />
          </view>
        </view>

        <view class="weui-cell">
          <view class="weui-cell__hd">
            <label class="weui-label">随访内容</label>
          </view>
          <view class="weui-cell__bd">
            <textarea 
              value="{{newFollowup.content}}" 
              placeholder="请输入本次随访的具体内容和建议..." 
              disabled="{{saving}}"
              bindinput="onNewFollowupInput"
              data-field="content"
              class="weui-textarea"
              rows="3"
            />
          </view>
        </view>
      </view>
    </view>

    <view class="weui-dialog__ft">
      <button class="weui-btn weui-btn_default" bindtap="hideModal" disabled="{{saving}}">取消</button>
      <button class="weui-btn weui-btn_primary" bindtap="handleSaveFollowup" disabled="{{saving}}">
        <i wx:if="{{saving}}" class="weui-loading weui-icon_in-btn"></i>
        <text>保存</text>
      </button>
    </view>
  </view>
</view>
  