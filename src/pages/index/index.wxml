
<!--index.wxml-->
<view class="container">
  <!-- 搜索栏 -->
  <search-bar 
    search-text="{{searchText}}" 
    bind:search="handleSearch" 
    bind:input="onSearchInput"
    bind:add-user="handleAddUser"
  ></search-bar>

  <!-- 数据总览卡片 -->
  <view class="dashboard-section">
    <view class="section-title">数据总览</view>
    <view class="stats-grid">
      <!-- 总用户数 -->
      <view class="stat-card primary">
        <view class="stat-icon">👥</view>
        <view class="stat-content">
          <view class="stat-value">{{dashboardStats.totalUsers}}</view>
          <view class="stat-label">用户总数</view>
        </view>
      </view>

      <!-- 本年新增 -->
      <view class="stat-card success">
        <view class="stat-icon">📈</view>
        <view class="stat-content">
          <view class="stat-value">{{dashboardStats.newUsersThisYear}}</view>
          <view class="stat-label">本年新增</view>
        </view>
      </view>

      <!-- 本月随访 -->
      <view class="stat-card warning">
        <view class="stat-icon">📅</view>
        <view class="stat-content">
          <view class="stat-value">{{dashboardStats.followedThisMonth}}</view>
          <view class="stat-label">本月随访</view>
        </view>
      </view>

      <!-- 已过期 -->
      <view class="stat-card danger">
        <view class="stat-icon">⏰</view>
        <view class="stat-content">
          <view class="stat-value">{{dashboardStats.overdueFollowup}}</view>
          <view class="stat-label">已过期</view>
        </view>
      </view>

      <!-- 无记录 -->
      <view class="stat-card secondary">
        <view class="stat-icon">📝</view>
        <view class="stat-content">
          <view class="stat-value">{{dashboardStats.noFollowupRecords}}</view>
          <view class="stat-label">无记录</view>
        </view>
      </view>
    </view>

    <!-- 统计图表 -->
    <view class="chart-container">
      <view class="chart-title">数据分布</view>
      <view class="chart-grid">
        <view 
          wx:for="{{chartData.labels}}" 
          wx:for-item="label" 
          wx:for-index="index" 
          class="chart-item"
        >
          <view class="chart-color" style="background-color: {{chartData.datasets[0].backgroundColor[index]}}"></view>
          <view class="chart-info">
            <view class="chart-value">{{chartData.datasets[0].data[index]}}</view>
            <view class="chart-label">{{label}}</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 用户列表 -->
  <view class="user-list-section">
    <view class="section-title">待随访用户</view>
    <view class="user-list">
      <block wx:for="{{filteredUsers}}" wx:key="_id">
        <user-card 
          user="{{item}}" 
          bind:click="handleUserClick" 
          bind:delete="handleDeleteClick"
        ></user-card>
      </block>
    </view>
    
    <!-- 空状态 -->
    <view wx:if="{{filteredUsers.length === 0 && !loading}}" class="empty-state">
      <image src="/images/empty-state.png" class="empty-image"></image>
      <text class="empty-text">暂无待随访用户</text>
    </view>
  </view>

  <!-- 加载状态 -->
  <loading wx:if="{{loading}}"></loading>

  <!-- 搜索模态框 -->
  <modal 
    show="{{showSearchModal}}" 
    title="搜索结果" 
    bind:close="hideSearchModal"
  >
    <view class="search-results">
      <block wx:for="{{searchResults}}" wx:key="_id">
        <user-card 
          user="{{item}}" 
          bind:click="handleSearchResultClick"
        ></user-card>
      </block>
      <view wx:if="{{searchResults.length === 0}}" class="empty-search">
        <text>未找到相关用户</text>
      </view>
    </view>
  </modal>

  <!-- 添加用户模态框 -->
  <modal 
    show="{{showAddUserModal}}" 
    title="添加用户" 
    bind:close="hideModal"
  >
    <view class="add-user-form">
      <view class="form-group">
        <text class="form-label">姓名</text>
        <input 
          class="form-input" 
          placeholder="请输入姓名" 
          value="{{newUserForm.name}}" 
          data-field="name"
          bindinput="onFormInput"
        />
      </view>
      <view class="form-group">
        <text class="form-label">手机号</text>
        <input 
          class="form-input" 
          placeholder="请输入手机号" 
          type="number"
          value="{{newUserForm.phone}}" 
          data-field="phone"
          bindinput="onFormInput"
        />
      </view>
      <view class="form-group">
        <text class="form-label">地址</text>
        <input 
          class="form-input" 
          placeholder="请输入地址" 
          value="{{newUserForm.address}}" 
          data-field="address"
          bindinput="onFormInput"
        />
      </view>
      <button 
        class="submit-btn" 
        bindtap="handleSaveNewUser" 
        loading="{{addUserLoading}}"
      >
        保存
      </button>
    </view>
  </modal>

  <!-- 删除确认对话框 -->
  <modal 
    show="{{showDeleteDialog}}" 
    title="确认删除" 
    bind:close="hideModal"
  >
    <view class="delete-dialog">
      <text>确定要删除用户 "{{userToDelete ? userToDelete.name : ''}}" 吗？</text>
      <view class="dialog-buttons">
        <button class="btn-cancel" bindtap="hideModal">取消</button>
        <button class="btn-confirm" bindtap="confirmDelete" loading="{{deleting}}">确定</button>
      </view>
    </view>
  </modal>
</view>
  