
<!--index.wxml-->
<view class="container">
  <!-- æœç´¢æ  -->
  <search-bar 
    search-text="{{searchText}}" 
    bind:search="handleSearch" 
    bind:input="onSearchInput"
    bind:add-user="handleAddUser"
  ></search-bar>

  <!-- æ•°æ®æ€»è§ˆå¡ç‰‡ -->
  <view class="dashboard-section">
    <view class="section-title">æ•°æ®æ€»è§ˆ</view>
    <view class="stats-grid">
      <!-- æ€»ç”¨æˆ·æ•° -->
      <view class="stat-card primary">
        <view class="stat-icon">ğŸ‘¥</view>
        <view class="stat-content">
          <view class="stat-value">{{dashboardStats.totalUsers}}</view>
          <view class="stat-label">ç”¨æˆ·æ€»æ•°</view>
        </view>
      </view>

      <!-- æœ¬å¹´æ–°å¢ -->
      <view class="stat-card success">
        <view class="stat-icon">ğŸ“ˆ</view>
        <view class="stat-content">
          <view class="stat-value">{{dashboardStats.newUsersThisYear}}</view>
          <view class="stat-label">æœ¬å¹´æ–°å¢</view>
        </view>
      </view>

      <!-- æœ¬æœˆéšè®¿ -->
      <view class="stat-card warning">
        <view class="stat-icon">ğŸ“…</view>
        <view class="stat-content">
          <view class="stat-value">{{dashboardStats.followedThisMonth}}</view>
          <view class="stat-label">æœ¬æœˆéšè®¿</view>
        </view>
      </view>

      <!-- å·²è¿‡æœŸ -->
      <view class="stat-card danger">
        <view class="stat-icon">â°</view>
        <view class="stat-content">
          <view class="stat-value">{{dashboardStats.overdueFollowup}}</view>
          <view class="stat-label">å·²è¿‡æœŸ</view>
        </view>
      </view>

      <!-- æ— è®°å½• -->
      <view class="stat-card secondary">
        <view class="stat-icon">ğŸ“</view>
        <view class="stat-content">
          <view class="stat-value">{{dashboardStats.noFollowupRecords}}</view>
          <view class="stat-label">æ— è®°å½•</view>
        </view>
      </view>
    </view>

    <!-- ç»Ÿè®¡å›¾è¡¨ -->
    <view class="chart-container">
      <view class="chart-title">æ•°æ®åˆ†å¸ƒ</view>
      <view class="chart-grid">
        <view 
          wx:for="{{chartData.labels}}" 
          wx:for-item="label" 
          wx:for-index="index" 
          class="chart-item"
        >
          <view class="chart-color" style="background-color: {{chartData.datasets[0].backgroundColor[index]}}"></view>
          <view class="chart-info">
            <view class="chart-value">{{chartData.datasets[0].data[index]}}</view>
            <view class="chart-label">{{label}}</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- ç”¨æˆ·åˆ—è¡¨ -->
  <view class="user-list-section">
    <view class="section-title">å¾…éšè®¿ç”¨æˆ·</view>
    <view class="user-list">
      <block wx:for="{{filteredUsers}}" wx:key="_id">
        <user-card 
          user="{{item}}" 
          bind:click="handleUserClick" 
          bind:delete="handleDeleteClick"
        ></user-card>
      </block>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{filteredUsers.length === 0 && !loading}}" class="empty-state">
      <image src="/images/empty-state.png" class="empty-image"></image>
      <text class="empty-text">æš‚æ— å¾…éšè®¿ç”¨æˆ·</text>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <loading wx:if="{{loading}}"></loading>

  <!-- æœç´¢æ¨¡æ€æ¡† -->
  <modal 
    show="{{showSearchModal}}" 
    title="æœç´¢ç»“æœ" 
    bind:close="hideSearchModal"
  >
    <view class="search-results">
      <block wx:for="{{searchResults}}" wx:key="_id">
        <user-card 
          user="{{item}}" 
          bind:click="handleSearchResultClick"
        ></user-card>
      </block>
      <view wx:if="{{searchResults.length === 0}}" class="empty-search">
        <text>æœªæ‰¾åˆ°ç›¸å…³ç”¨æˆ·</text>
      </view>
    </view>
  </modal>

  <!-- æ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡† -->
  <modal 
    show="{{showAddUserModal}}" 
    title="æ·»åŠ ç”¨æˆ·" 
    bind:close="hideModal"
  >
    <view class="add-user-form">
      <view class="form-group">
        <text class="form-label">å§“å</text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥å§“å" 
          value="{{newUserForm.name}}" 
          data-field="name"
          bindinput="onFormInput"
        />
      </view>
      <view class="form-group">
        <text class="form-label">æ‰‹æœºå·</text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥æ‰‹æœºå·" 
          type="number"
          value="{{newUserForm.phone}}" 
          data-field="phone"
          bindinput="onFormInput"
        />
      </view>
      <view class="form-group">
        <text class="form-label">åœ°å€</text>
        <input 
          class="form-input" 
          placeholder="è¯·è¾“å…¥åœ°å€" 
          value="{{newUserForm.address}}" 
          data-field="address"
          bindinput="onFormInput"
        />
      </view>
      <button 
        class="submit-btn" 
        bindtap="handleSaveNewUser" 
        loading="{{addUserLoading}}"
      >
        ä¿å­˜
      </button>
    </view>
  </modal>

  <!-- åˆ é™¤ç¡®è®¤å¯¹è¯æ¡† -->
  <modal 
    show="{{showDeleteDialog}}" 
    title="ç¡®è®¤åˆ é™¤" 
    bind:close="hideModal"
  >
    <view class="delete-dialog">
      <text>ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "{{userToDelete ? userToDelete.name : ''}}" å—ï¼Ÿ</text>
      <view class="dialog-buttons">
        <button class="btn-cancel" bindtap="hideModal">å–æ¶ˆ</button>
        <button class="btn-confirm" bindtap="confirmDelete" loading="{{deleting}}">ç¡®å®š</button>
      </view>
    </view>
  </modal>
</view>
  